@using Microsoft.AspNetCore.Mvc.TagHelpers
@using Org.BouncyCastle.Crypto.Engines
@model Web.ViewModels.Booking.SelectTicketViewModel
@{
    Layout = null;
}
<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="~/css/select-ticket.css">
    <title>Chọn vé</title>
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <!-- Phần chọn vé bên trái -->
        <div class="col-lg-9 col-left">
            <div class="ticket-list-container">
                <div class="header-section mb-4">
                    <div class="d-flex align-items-center">
                        <a href="javascript:history.back()" class="btn btn-outline-secondary me-3">
                            <i class="fas fa-arrow-left"></i>
                        </a>
                        <h3 class="mb-0">Chọn vé cho sự kiện</h3>
                    </div>
                    <p class="text-muted mt-2 mb-0">Vui lòng chọn loại vé và số lượng bạn muốn đặt</p>
                </div>

                @foreach (var ticket in Model.ticketDTOs)
                {
                    <div class="ticket-card">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h5>@ticket.Title</h5>
                                <div class="ticket-description">
                                    @ticket.Description
                                </div>
                                <div class="ticket-price">@ticket.Price.ToString("N0") VNĐ</div>
                                <div class="text-muted small">
                                    <i class="fas fa-ticket-alt me-1"></i>
                                    Còn @ticket.QuantityAvailable vé | Tối đa @ticket.MaxPerPerson vé/người
                                </div>
                            </div>
                            <div class="d-flex align-items-start">
                                <button class="btn btn-outline-secondary btn-circle" 
                                        onclick="decreaseQuantity('@ticket.Id')"
                                        id="decrease-@ticket.Id">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <input type="number" 
                                       id="quantity-@ticket.Id" 
                                       class="form-control quantity-input" 
                                       value="0" 
                                       min="0" 
                                       max="@ticket.MaxPerPerson"
                                       onchange="validateQuantity(this, @ticket.MaxPerPerson)">
                                <button class="btn btn-outline-secondary btn-circle" 
                                        onclick="increaseQuantity('@ticket.Id')"
                                        id="increase-@ticket.Id">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- Phần summary bên phải -->
        <div class="col-lg-3 col-right">
            <div class="summary-card">
                <div class="summary-content">
                    <h4>Thông tin đặt vé</h4>
                    <div class="event-info">
                        <h5>@Model.eventDTO.Title</h5>
                        <div class="event-datetime mb-2">
                            @if (Model.eventDTO.StartDate.HasValue)
                            {
                                <p class="text-muted mb-1">
                                    <i class="far fa-calendar-alt me-2"></i>
                                    @Model.eventDTO.StartDate.Value.ToString("dd/MM/yyyy")
                                    @if (Model.eventDTO.EndDate.HasValue && Model.eventDTO.EndDate.Value != Model.eventDTO.StartDate.Value)
                                    {
                                        <span> - @Model.eventDTO.EndDate.Value.ToString("dd/MM/yyyy")</span>
                                    }
                                </p>
                            }
                            @if (Model.eventDTO.StartTime.HasValue)
                            {
                                <p class="text-muted mb-1">
                                    <i class="far fa-clock me-2"></i>
                                    @Model.eventDTO.StartTime.Value.ToString(@"hh\:mm")
                                    @if (Model.eventDTO.EndTime.HasValue)
                                    {
                                        <span> - @Model.eventDTO.EndTime.Value.ToString(@"hh\:mm")</span>
                                    }
                                </p>
                            }
                        </div>
                        <div class="event-location">
                            @if (!string.IsNullOrEmpty(Model.eventDTO.VenueName))
                            {
                                <p class="text-muted mb-1">
                                    <i class="fas fa-map-marker-alt me-2"></i>
                                    @Model.eventDTO.VenueName
                                </p>
                            }
                            @if (!string.IsNullOrEmpty(Model.eventDTO.Address))
                            {
                                <p class="text-muted small mb-1">@Model.eventDTO.Address</p>
                            }
                            @if (!string.IsNullOrEmpty(Model.eventDTO.Ward) || !string.IsNullOrEmpty(Model.eventDTO.District) || !string.IsNullOrEmpty(Model.eventDTO.City))
                            {
                                <p class="text-muted small mb-1">
                                    @(!string.IsNullOrEmpty(Model.eventDTO.Ward) ? Model.eventDTO.Ward + ", " : "")
                                    @(!string.IsNullOrEmpty(Model.eventDTO.District) ? Model.eventDTO.District + ", " : "")
                                    @Model.eventDTO.City
                                </p>
                            }
                        </div>
                    </div>
                    <hr>
                    <div class="ticket-summary">
                        <h6>Vé đã chọn</h6>
                        <div id="selected-tickets">
                            @foreach (var ticket in Model.ticketDTOs)
                            {
                                <div id="ticket-summary-@ticket.Id" class="d-none">
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>@ticket.Title x <span id="count-@ticket.Id">0</span></span>
                                        <span id="total-@ticket.Id">0 VNĐ</span>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
                <div class="summary-footer">
                    <div class="d-flex justify-content-between mb-2">
                        <h6>Tổng số vé:</h6>
                        <h6 id="total-tickets">0 vé</h6>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <h6>Tổng tiền:</h6>
                        <h6 id="total-amount">0 VNĐ</h6>
                    </div>
                    <form id="ticketForm" asp-controller="Booking" asp-action="SelectTicket" method="post">
                        <input type="hidden" id="selectedTicketsData" name="selectedTickets" />
                        <button type="submit" class="btn btn-primary w-100">Tiếp tục</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Thêm div để tạo padding bottom khi summary fixed ở mobile -->
<div class="summary-spacer d-lg-none" style="height: 60vh;"></div>

<script src="~/js/select-ticket.js"></script>
<script>
document.getElementById('ticketForm').onsubmit = function(e) {
    e.preventDefault();
    
    // Tạo object chứa các vé được chọn
    const selectedTickets = {};
    document.querySelectorAll('.quantity-input').forEach(input => {
        const ticketId = input.id.replace('quantity-', '');
        const quantity = parseInt(input.value);
        if (quantity > 0) {
            selectedTickets[ticketId] = quantity;
        }
    });

    // Gán dữ liệu vào hidden input
    document.getElementById('selectedTicketsData').value = JSON.stringify(selectedTickets);
    
    // Submit form
    this.submit();
};
</script>
</body>
</html>